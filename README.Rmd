---
output: md_document
params:
  generating_pkgdown_index: false
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dpi = 300,
  message = FALSE
)
```

# isoorbi <a href='https://isoorbi.isoverse.org/'> <img src="inst/www/logo.png" align="right" height="138" /> </a>

<!-- badges: start -->
  [![CRAN status](https://www.r-pkg.org/badges/version/isoorbi)](https://CRAN.R-project.org/package=isoorbi)
  [![Documentation](https://img.shields.io/badge/docs-online-green.svg)](https://isoorbi.isoverse.org/)
  [![R-CMD-check](https://github.com/isoverse/isoorbi/workflows/R-CMD-check/badge.svg)](https://github.com/isoverse/isoorbi/actions)
  [![Codecov test coverage](https://codecov.io/gh/isoverse/isoorbi/graph/badge.svg)](https://app.codecov.io/gh/isoverse/isoorbi)
<!-- badges: end -->

## Overview

The goal of the isoorbi R package is to help you process isotopocule measurements from an **Orbitrap Isotope Solutions** mass spectrometer. It can read both the <code>.raw</code> files (recommended approach) as well as <code>.isox</code> output created by IsoX (legacy approach).

## Installation

You can install the current CRAN version of `isoorbi` with:

```{r, eval = FALSE}
# install the isoorbi package
install.packages("isoorbi")
# check/install the isoraw reader
isoorbi::orbi_check_isoraw()
```

To use the latest updates, you can install the development version of `isoorbi` from [GitHub](https://github.com/). If you are on Windows, make sure to install the equivalent version of [Rtools](https://cran.r-project.org/bin/windows/Rtools/) for your version of R (you can find out which version you have with `getRversion()` from an R console - note that isoorbi requires [R version](https://cran.r-project.org/) 4.4 or newer).

```{r, eval = FALSE}
# checks that you are set up to build R packages from source
if(!requireNamespace("pkgbuild", quietly = TRUE)) install.packages("pkgbuild")
pkgbuild::check_build_tools()

# installs the latest isoorbi package from GitHub
if(!requireNamespace("pak", quietly = TRUE)) install.packages("pak")
pak::pak("isoverse/isoorbi")

# check/install the isoraw reader
isoorbi::orbi_check_isoraw()
```

> Important: as of isoorbi version 1.5.0, it is possible to read .raw files directly using the [isoraw reader](https://github.com/isoverse/isoorbi/tree/main/inst/assembly) built into this package. The first time you read a .raw file, you will be asked to agree to [Thermo's license agreement](https://github.com/fgcz/rawrr/blob/devel/inst/rawrrassembly/RawFileReaderLicense.txt) to proceed. Implementation of the isoraw reader, would not have been possible without the example provided by Jim Shofstahl as part of Thermo's [RawFileReader](https://github.com/thermofisherlsms/RawFileReader) and the raw file reader developed by Witold Wolski, Christian Panse, Christian Trachsel, and Tobias Kockmann as part of the [rawrr package](https://github.com/fgcz/rawrr).


## Show me some code

### Read raw data file

```{r eval = FALSE}
# load library
library(isoorbi)

# provide the path to your data folder here:
my_data_folder <- file.path("project", "data")

# and search for raw files in that folder
file_paths <- orbi_find_raw(my_data_folder)

# for this example, we use a small raw test file bundled with the
# package instead (remove this line if working with your own data)
file_paths <- orbi_get_example_files("nitrate_test_10scans.raw")

# read the raw file incluing 2 of the raw spectra
raw_files <- file_paths |>
    orbi_read_raw(include_spectra = c(1, 10))

# aggregate the raw data (processes the read files)
raw_agg <- raw_files |> orbi_aggregate_raw()

# plot the spectra
raw_agg |> orbi_plot_spectra()
```

```{r "read-raw", messages = FALSE, echo = FALSE, fig.width = 8, fig.height = 4}
library(isoorbi)
file_paths <- orbi_get_example_files("nitrate_test_10scans.raw")
raw_agg <- file_paths |>
    orbi_read_raw(include_spectra = c(1, 10)) |>
    orbi_aggregate_raw()
raw_agg |> orbi_plot_spectra()
```

### Identify isotopcules

```{r "map-isotopocules", messages = FALSE, fig.width = 8, fig.height = 4}
# identify isotopcules
# these could also come from a data frame or a tsv/csv/excel file
raw_agg <- raw_agg |> orbi_identify_isotopocules(
  isotopocules = 
    c("M0" = 61.9878, "15N" = 62.9850, "17O" = 62.9922, "18O" = 63.9922)
)

# plot again, now with the isotopocules identified
raw_agg |> orbi_plot_spectra()
```

### Process data

```{r "process-data", messages = FALSE, fig.width = 8, fig.height = 4}
# process raw files data
dataset <- raw_agg |>
  # filter out unidentified peaks
  orbi_filter_isotopocules() |>
  # check for satellite peaks
  orbi_flag_satellite_peaks() |>
  # define base peak
  orbi_define_basepeak(basepeak_def = "M0")

# plot the resulting isotopocule ratios
dataset |> orbi_plot_raw_data(y = ratio)
```

### Summarize results

```{r "summarize", eval = FALSE}
# calculate ratios across scans
results <- dataset |> orbi_summarize_results(ratio_method = "sum")
   
# print results
results |>  orbi_get_data(summary = c("isotopocule", "ratio", "ratio_sem"))

# export results to excel
results |> orbi_export_data_to_excel(
  file = "data_summary.xlsx",
  include = c("file_info", "summary")
)
```

```{r "summarize-code", echo = FALSE, messages = FALSE}
results <- dataset |> orbi_summarize_results(ratio_method = "sum")
results |>  orbi_get_data(summary = c("isotopocule", "ratio", "ratio_sem"))
```

For additional code, please check out our **Examples** in the main menu at [isoorbi.isoverse.org](https://isoorbi.isoverse.org/), and peruse the full package structure below.

## Package structure

```{r}
#| echo: false
#| results: asis
if (params$generating_pkgdown_index) {
  # if we're in index.md
  cat("<p>Click on the individual functions to jump straight to their documenation.</p>\n")
  readLines("man/figures/figure_flowchart.svg") |> cat(sep = "\n")
} else {
  # if we're making README.md
  cat("[![](man/figures/figure_flowchart.svg)](https://isoorbi.isoverse.org/#package-structure)")
}
```

```{r}
#| label: generate pkgdown index.md
#| include: false
# trigger index.md generation
if (!params$generating_pkgdown_index) {
  out <- xfun::Rscript_call(
    rmarkdown::render,
    args = list(
      input = "README.Rmd", 
      output_file = "pkgdown/index.md",
      params = list(generating_pkgdown_index = TRUE)
    )
  )
}
```

## Getting help

If you encounter a bug, please file an issue with a minimal reproducible example on [GitHub](https://github.com/isoverse/isoorbi/issues). 

For questions and other discussion, please use the [isoorbi slack workspace](https://isoorbi.slack.com).

## isoverse <a href='http://www.isoverse.org'><img src='man/figures/isoverse_logo_thumb.png' align="right" height="138.5"/></a>

This package is part of the isoverse suite of data tools for stable isotopes. If you like the functionality that isoverse packages provide to the geochemical community, please help us spread the word and include an isoverse or individual package logo on one of your posters or slides. All logos are posted in high resolution in [this repository](https://github.com/isoverse/logos). If you have suggestions for new features or other constructive feedback, please let us know on this short [feeback form](https://www.isoverse.org/feedback/).